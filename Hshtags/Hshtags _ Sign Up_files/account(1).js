"use strict";var account_directives=angular.module("account.directives",[]);account_directives.directive("stepBtn",[function(){var e=function(e,t){t.on("click",function(t){t.preventDefault();var a=this.hash;if($(a).removeClass("hidden"),$(".step-full").not(a).addClass("hidden"),"#sInfo"===a)$(".step-title").text("Account Info"),$(".step-desc").text("In order to provide the best experience, we are going to need a few things. Let's start with the basics.");else if("#sSocial"===a)$(".step-title").text("Social Authorization"),$(".step-desc").text("Please authorize one or more of the following social platforms in order to see a wider variety of posts.");else if("#sFinal"===a)if($(".step-title").text("Complete Sign Up"),$(".step-desc").html('By clicking Sign Up, you agree to our <a href="/company/terms" target="_blank">Terms</a> and that you have read our <a href="/company/privacy" target="_blank">Data Use Policy</a>.'),$.isEmptyObject(e.new_user.social_auth))$("#sFinal h3").text("Oops"),$("#sFinal p").html("In order to provide you with the best service, you need to authorize at least one account to use Hshtags."),0===$("#sFinal").find(".error-emoticon").length&&$("#sFinal .right-col.auth-btns").after('<span class="error-emoticon"><span></span></span>'),$("#sFinal .back-to-info").show(),$("#sFinal .create-acct").hide();else{var i=0;$.each(e.new_user.social_auth,function(e,t){0===$("#sFinal .auth-btns").find(".social-auth."+t.oauth_provider.toLowerCase()).length&&$("#sFinal .auth-btns").append('<div class="social-auth '+t.oauth_provider.toLowerCase()+' selected"><span class="icon-wrapper"><span class="'+t.oauth_provider.toLowerCase()+'-grey-sm"></span></span></div>'),i++}),$("#sFinal h3").html('Excellent! You authorized <span class="num-auth">'+i+" accounts.</span>"),$("#sFinal p").html("Next time, you may log in with any one of these authorized accounts."),$("#sFinal .enter-site").show(),$("#sFinal .create-acct").show(),$("#sFinal .error-emoticon").length>0&&$("#sFinal .error-emoticon").remove()}})};return{link:e}}]),account_directives.directive("signUpForm",["htgUser",function(e){var t=function(t,a){a.on("submit",function(i){i.preventDefault();var n=!1,r=!1,o=!1,s={fullname_valid:!1,username_valid:!1,email_valid:!1};t.signupform.fullname.$error.name_valid=s.fullname_valid=""===t.new_user.htg_name?!0:t.signupform.fullname.$error.name_valid,t.signupform.username.$error.uname_charcount=s.username_valid=""===t.new_user.username||t.new_user.username.length<5?!0:t.signupform.username.$error.uname_charcount,t.signupform.email.$error.email_valid=s.email_valid=""===t.new_user.email?!0:t.signupform.email.$error.email_valid,(s.fullname_valid||s.username_valid||s.email_valid)&&(t.signupform.$valid=!1);e.validate(t.new_user,function(e){null!==e.data.unique_username&&(e.data.unique_username?($(".username.error.unique").text(""),r=!0):($(".username.error.unique").text("Sorry, that username is taken."),r=!1)),null!==e.data.unique_email&&(e.data.unique_email?($(".email.error.unique").text(""),o=!0):($(".email.error.unique").text("Sorry, that email address has already been used."),o=!1)),n=r&&o?!0:!1,t.signupform.$valid&&n&&!a.hasClass(".ng-invalid")&&($(".stepper .step").removeClass("disabled"),$('.stepper .step[href="#sInfo"]').removeClass("active"),$('.stepper .step[href="#sSocial"]').addClass("active"),$(".step-full").not("#sSocial").addClass("hidden"),$(".step-full#sSocial").removeClass("hidden"),$(".step-title").text("Social Authorization"),$(".step-desc").text("Please authorize one or more of the following social platforms in order to see a wider variety of posts."))})}),a.find("input").on("keydown",function(){var e=$(this).attr("name");$("."+e+".error.unique").text("")})};return{link:t}}]),account_directives.directive("fullname",function(){var e=/[^A-z0-9-/\s/]/g,t=function(t,a,i,n){n.$parsers.unshift(function(t){return angular.isDefined(t)?("name"===t||""===t||e.test(t)||e.test(t)===!0?n.$setValidity("name_valid",!1):n.$setValidity("name_valid",!0),t):void n.$setValidity("name_valid",!1)})};return{require:"ngModel",link:t}}),account_directives.directive("username",function(){var e=/[^A-z0-9_-]/g,t=function(t,a,i,n){n.$parsers.unshift(function(t){return angular.isDefined(t)?("username"===t||""===t||t.length<5?n.$setValidity("uname_charcount",!1):n.$setValidity("uname_charcount",!0),e.test(t)||e.test(t)===!0?n.$setValidity("uname_valid",!1):n.$setValidity("uname_valid",!0),t):void n.$setValidity("uname_valid",!1)})};return{require:"ngModel",link:t}}),account_directives.directive("emailAddress",function(){var e=function(e,t,a,i){i.$parsers.unshift(function(e){var t=e.indexOf("@"),a=e.lastIndexOf(".");return angular.isDefined(e)?(""===e||1>t||t+2>a||a+2>=e.length?i.$setValidity("email_valid",!1):i.$setValidity("email_valid",!0),e):void i.$setValidity("email_valid",!1)})};return{require:"ngModel",link:e}}),account_directives.directive("powerAccount",function(){var e=function(e,t){t.on("change",".power-checkbox",function(){})};return{link:e}}),account_directives.directive("socialAuth",["$rootScope","htgUser","loggedInUser",function(e,t,a){var i=function(e,i){function n(){l++,s.closed?(o=JSON.parse($("#inline_auth_response").attr("data-response")),r(),clearInterval(u)):l>3e5&&(s.close(),i.find(".auth-error").html("Something went wrong, try again."))}function r(){if(void 0===o.social||""===o.social)i.find(".auth-error").html("Something went wrong, try again."),e.page.settings&&setTimeout(function(){i.find(".auth-error").html("")},5e3);else if(e.page.signup)o.duplicate_error===!0||"true"===o.duplicate_error?i.find(".auth-error").html("That  "+o.social+' account has already been authorized. <a href="/account/login">Click here to Log In.</a>'):o.success===!1||"false"===o.success?i.find(".auth-error").html("Something went wrong, try again."):(e.new_user.social_auth[o.social]=o.auth,e.new_user.user_img=""!==o.user_img&&void 0!==o.user_img?o.user_img:e.new_user.user_img,i.find(".auth-error").html(""),i.find("#inline_auth_response").removeAttr("data-response"),i.find(".social-platforms ."+o.social).addClass("authenticated"),i.find(".insight .inline-auth").addClass("htg-authorized"),i.find(".insight .inline-auth").text("Auth Done"));else if(e.page.login);else if(e.page.settings){var n={social_auth:{}};o.auth.user_id=a.luser.user_id,n.social_auth[o.social]=o.auth;{var r={user_id:a.luser.user_id,update:JSON.stringify(n)};t.update(r,function(t){if(t.data.social_auth.response.success){e.luser.socials_authorized.push(o.social),e.social_auth[o.social]=!0;var a=e.luser.socials_expired.indexOf(o.social);e.luser.socials_expired.splice(a,1),e.social_expired[o.social]=!1,0===e.luser.socials_expired.length&&(e.expired_auth_note="")}})}}}var o,s,u,l=0,d={facebook:{title:"Facebook Junkie?",description:"To sign in with Facebook, please authorize your facebook account (it is no longer supported in the feed)."},twitter:{title:"Twitter Fanatic?",description:"To see tweets from within your network, please authorize your twitter account."},instagram:{title:"Instagrammer?",description:"To see instaphotos from within your network, please authorize your twitter account."},tumblr:{title:"Tumblr Blogger?",description:"To see tumblr posts from within your network, please authorize your tumblr account."},vimeo:{title:"Vimeographer?",description:"To see  vimeo videos from within your network, please authorize your vimeo account."},flickr:{title:"Flickr Pro?",description:"To see flickr images from within your network, please authorize your flickr account."}};i.on("click",".social-auth",function(){if(e.page.signup){i.find(".social-auth").removeClass("selected"),$(this).addClass("selected");var t=$(this).attr("data-social");i.find(".insight .title").text(d[t].title),i.find(".insight .description").text(d[t].description),i.find(".insight .inline-auth").attr("href","/auth/login/"+t),void 0!==e.new_user.social_auth[t]?(i.find(".insight .inline-auth").addClass("htg-authorized"),i.find(".insight .inline-auth").text("Auth Done")):(i.find(".insight .inline-auth").removeClass("htg-authorized"),i.find(".insight .inline-auth").text("Click Here"))}i.find(".auth-error").html("")}),i.on("click",".inline-auth",function(e){e.preventDefault();var t=$(this).attr("href"),a=$(this).attr("data-title"),i=$(this).attr("data-width"),r=$(this).attr("data-height");s=window.open(t,a,"width="+i+",height="+r),s.focus(),u=setInterval(n,1e3)})};return{link:i}}]),account_directives.directive("createAcctBtn",["htgUser",function(e){var t=function(t,a){a.on("click",function(i){i.preventDefault(),a.html("Creating...").addClass("creating");{var n=(this.href,{new_user:JSON.stringify(t.new_user)});e.create(n,function(e){e.data.success&&(window.location="/account/created?user_id="+e.data.user_id)})}})};return{link:t}}]),account_directives.directive("updateHomeTag",["htgUser",function(e){var t=function(t,a){a.on("submit",function(i){i.preventDefault();var n=a.find(".tag-chosen").val();n=n.replace(/[\s#]/g,"");{var r={user_id:t.luser.user_id,update:JSON.stringify({default_homepage:"tags/v/"+n})};e.update(r,function(e){t.default_hometag=n,t.default_homepage=e.data.default_homepage,a.find(".tag-chosen").val("")})}})};return{link:t}}]),account_directives.directive("updatePlan",["htgUser",function(){var e=function(e,t){t.on("click",".update-plan-btn",function(e){e.preventDefault();var t=angular.element(this).attr("data-type"),a=angular.element(this).attr("data-allow-trial");if("upgrade"===t)angular.element(".module.upgrade-plan").find('input[name="allow_trial"]').val(a),$(".overlay").fadeIn(700,function(){angular.element(".module.upgrade-plan").fadeIn()});else if("downgrade"===t){var i=angular.element(this).attr("data-scus-id");angular.element(".notification.downgrade-plan").find('input[name="scus-id"]').val(i),$(".overlay").fadeIn(700,function(){angular.element(".notification.downgrade-plan").fadeIn()})}}),t.on("click",".edit-card-btn",function(e){e.preventDefault(),$(".overlay").fadeIn(700,function(){angular.element(".module.edit-card").fadeIn()})})};return{link:e}}]),account_directives.directive("upgradePlan",["htgUser","loggedInUser","$rootScope",function(e,t,a){var i=function(i,n){function r(e,t){200===e?(i.card_error="",i.$apply(),o(t.id,t.card.last4)):(n.find(".submit-txt").html("Upgrade"),n.find('input[type="submit"]').prop("disabled",!1),i.card_error=t.error.message,i.$apply())}function o(r,o){void 0!==r&&void 0!==o&&(l={subscription_plan:{email:t.luser.email,trial:"true"===i.allow_trial?!0:!1,card_token:r,card_last4:o}},u={user_id:t.luser.user_id,update:JSON.stringify(l)}),e.update(u,function(e){if(e.data.subscription_plan.success){var t={power:!0,card_number:e.data.subscription_plan.card_last4,account_type:e.data.subscription_plan.account_type,trial_end:e.data.subscription_plan.trial_end_date};a.$broadcast("plan_updated",t),n.fadeOut(700,function(){$(".overlay").fadeOut()})}else i.card_error=e.data.subscription_plan.error})}var s,u,l;n.on("submit",function(e){e.preventDefault(),n.find(".submit-txt").html("Submitting.."),n.find('input[type="submit"]').prop("disabled",!0),i.allow_trial=n.find('input[name="allow_trial"]').val(),l={subscription_plan:{email:t.luser.email,trial:"true"===i.allow_trial?!0:!1}},""!==i.card.number&&""!==i.card.cvc&&"Month"!==i.card.month&&"Month"!==i.card.year?(l.subscription_plan.card=i.card,s=!1):s="true"===i.allow_trial?!1:!0,s?(n.find(".submit-txt").html("Upgrade"),n.find('input[type="submit"]').prop("disabled",!1),i.card_error="Please enter your full card details.",i.$apply()):(i.card_error="",i.$apply(),u={user_id:t.luser.user_id,update:JSON.stringify(l)},void 0!==l.subscription_plan.card?Stripe.card.createToken(n,r):o())}),n.on("click",".cancel-btn",function(e){e.preventDefault(),n.fadeOut(700,function(){$(".overlay").fadeOut(),i.card={month:"Month",year:"Year",fullname:t.luser.fullname},i.card_error="",i.$apply()})})};return{link:i}}]),account_directives.directive("downgradePlan",["htgUser","loggedInUser","$rootScope",function(e,t,a){var i=function(i,n){n.on("submit",function(i){i.preventDefault(),n.find(".submit-txt").html("Submitting.."),n.find('input[type="submit"]').prop("disabled",!0);var r={user_id:t.luser.user_id,update:JSON.stringify({subscription_plan:{email:t.luser.email,downgrade:!0}})};e.update(r,function(e){e.data.subscription_plan.success&&(a.$broadcast("plan_updated",{power:!1}),n.fadeOut(700,function(){$(".overlay").fadeOut()}))})}),n.on("click",".cancel-btn",function(e){e.preventDefault(),n.fadeOut(700,function(){$(".overlay").fadeOut()})})};return{link:i}}]),account_directives.directive("editCard",["htgUser","loggedInUser","$rootScope",function(e,t,a){var i=function(i,n){function r(r,o){200===r?(i.card_error="",i.$apply(),void 0!==o.id&&void 0!==o.card.last4&&(s={user_id:t.luser.user_id,update:JSON.stringify({subscription_plan:{email:t.luser.email,card_token:o.id,card_last4:o.card.last4,update_card:!0}})}),e.update(s,function(e){e.data.subscription_plan.success?(a.$broadcast("plan_updated",{power:!0,card_number:e.data.subscription_plan.card_last4}),n.fadeOut(700,function(){$(".overlay").fadeOut()})):i.card_error=e.data.subscription_plan.error})):(n.find(".submit-txt").html("Save"),n.find('input[type="submit"]').prop("disabled",!1),i.card_error=o.error.message,i.$apply())}var o,s;n.on("submit",function(e){e.preventDefault(),n.find(".submit-txt").html("Submitting.."),n.find('input[type="submit"]').prop("disabled",!0),o=""!==i.card.number&&""!==i.card.cvc&&"Month"!==i.card.month&&"Month"!==i.card.year?!1:!0,o?(n.find(".submit-txt").html("Save"),n.find('input[type="submit"]').prop("disabled",!1),i.card_error="Please enter your full card details.",i.$apply()):(i.card_error="",i.$apply(),s={user_id:t.luser.user_id,update:JSON.stringify({subscription_plan:{email:t.luser.email,card:i.card,update_card:!0}})},Stripe.card.createToken(n,r))}),n.on("click",".cancel-btn",function(e){e.preventDefault(),n.fadeOut(700,function(){$(".overlay").fadeOut(),i.card={month:"Month",year:"Year",fullname:t.luser.fullname},i.card_error="",i.$apply()})})};return{link:i}}]),account_directives.directive("deleteAcctConf",["htgUser",function(e){var t=function(t,a){var i="",n=a.find(".confirm-delete"),r=a.find(".cancel-delete");$("form.delete-account").submit(function(e){e.preventDefault(),i=$('input[name="current-user-id"]').val(),a.find('input[name="del-user-id"]').val(i),$(".overlay").fadeIn(700,function(){a.fadeIn()})}),n.on("click",function(t){t.preventDefault();{var i={user_id:a.find('input[name="del-user-id"]').val()};e.delete(i,function(){window.location="/auth/logout"})}}),r.on("click",function(e){e.preventDefault(),a.find('input[name="del-user-id"]').val(""),a.fadeOut(700,function(){$(".overlay").fadeOut()})})};return{link:t}}]);